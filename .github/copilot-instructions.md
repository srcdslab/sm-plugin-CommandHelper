# Copilot Instructions for CommandHelper SourceMod Plugin

## Repository Overview
This repository contains the **CommandHelper** SourceMod plugin, which automatically generates documentation for SourceMod commands and provides an in-game command browser. The plugin scans all loaded SourceMod commands (prefixed with `sm_` and `zr_`) and creates comprehensive markdown documentation with admin flags, descriptions, and provides an interactive menu system for players.

**Key Functionality:**
- Scans and catalogs all SourceMod commands from loaded plugins
- Generates markdown documentation (`COMMANDHELPER.md`) with admin flags and descriptions
- Provides `sm_listcmd` command for in-game command browsing
- Categorizes commands into admin and console commands
- Automatically sorts commands alphabetically

## Technical Environment

### Language & Platform
- **Language**: SourcePawn (SourceMod scripting language)
- **Platform**: SourceMod 1.12+ (minimum version 1.11.0-git6917 as per build config)
- **Compiler**: SourcePawn compiler (spcomp) via SourceKnight build system
- **Target**: Source engine game servers (CS:GO, TF2, L4D2, etc.)

### Build System
- **Build Tool**: SourceKnight (automated SourceMod build system)
- **Configuration**: `sourceknight.yaml` in repository root
- **CI/CD**: GitHub Actions using `maxime1907/action-sourceknight@v1`
- **Output**: Compiled `.smx` plugin files in `addons/sourcemod/plugins/`

### Dependencies
- **SourceMod**: Version 1.11.0-git6917 (auto-downloaded by SourceKnight)
- **Basic Plugin**: External dependency from `https://github.com/srcdslab/sm-plugin-Basic`
- **Include Files**: CCommandHelper.inc (custom methodmap class)

## Project Structure

```
addons/sourcemod/
├── scripting/
│   ├── CommandHelper.sp          # Main plugin source code
│   └── include/
│       └── CCommandHelper.inc    # Custom methodmap class for command objects
├── plugins/                      # Compiled output (generated by build)
├── configs/                      # Configuration files (generated)
│   └── COMMANDHELPER.md         # Auto-generated command documentation
└── translations/                 # Language files (if needed)

.github/
├── workflows/
│   └── ci.yml                   # GitHub Actions CI/CD pipeline
└── dependabot.yml              # Dependency updates

sourceknight.yaml                # Build system configuration
COMMANDHELPER.md                # Generated documentation (repository root)
```

## Code Style & Standards

### SourcePawn Conventions
```sourcepawn
#pragma semicolon 1              // Enforce semicolons
#pragma newdecls required        // Require new declaration syntax

// Variable naming
ArrayList g_aCommands = null;     // Global variables prefixed with "g_"
char sCommand[64];               // Local variables use camelCase
int iFlags;                      // Hungarian notation for integers

// Function naming
public void OnPluginStart()      // PascalCase for functions
stock bool LoadCommands()        // PascalCase for stock functions

// Memory management
delete g_aCommands;              // Always use delete (no null checks needed)
g_aCommands = new ArrayList();   // Recreate after deletion (no .Clear())
```

### Memory Management Best Practices
- **NEVER** use `.Clear()` on StringMap/ArrayList (causes memory leaks)
- **ALWAYS** use `delete` to free memory and create new instances
- No need to check for null before calling `delete`
- Properly iterate and delete contents before deleting containers

### Code Organization
- Use methodmaps for object-oriented patterns (see `CCommandHelper`)
- Implement `OnPluginStart()` for initialization
- Implement `OnPluginEnd()` for cleanup (only if necessary)
- Use `stock` functions for utility functions
- Group related functionality together

## Key Patterns & Architecture

### CCommandHelper Methodmap
```sourcepawn
methodmap CCommandHelper < Basic
{
    // Constructor
    public CCommandHelper() { /* creates Basic instance */ }
    
    // Getters/Setters
    public bool GetCommand(char[] buffer, int length)
    public void SetCommand(const char[] buffer)
    public bool GetDescription(char[] buffer, int length) 
    public void SetDescription(const char[] buffer)
    
    // Properties
    property int iFlags { public get() { } public set(int value) { } }
}
```

### Plugin Lifecycle
1. **OnPluginStart()**: Register console commands
2. **OnAllPluginsLoaded()**: Scan all commands and generate documentation
3. **LoadCommands()**: Iterate through SourceMod command registry
4. **SaveCommandsDocumentation()**: Generate markdown file

### Command Scanning Pattern
```sourcepawn
Handle commandIterator = GetCommandIterator();
while (ReadCommandIterator(commandIterator, sCommand, sizeof(sCommand), flags, sDescription, sizeof(sDescription)))
{
    if (StrContains(sCommand, "sm_") == 0 || StrContains(sCommand, "zr_") == 0)
    {
        // Process SourceMod commands
    }
}
```

## Development Workflow

### Building the Plugin
```bash
# Using GitHub Actions (recommended)
git push  # Triggers automatic build via CI

# Local build (requires SourceKnight setup)
# Note: SourceKnight typically runs in Docker container
# See sourceknight.yaml for exact build configuration
```

### Testing Changes
1. **Code Validation**: Ensure SourcePawn syntax is correct
2. **Build Testing**: Verify compilation succeeds
3. **Functional Testing**: Deploy to test server and verify:
   - Plugin loads without errors
   - `sm_listcmd` command works
   - Documentation generates correctly
   - Admin flags are properly detected

### File Locations for Testing
- **Plugin**: `addons/sourcemod/plugins/CommandHelper.smx`
- **Documentation**: `addons/sourcemod/configs/COMMANDHELPER.md`
- **Source**: `addons/sourcemod/scripting/CommandHelper.sp`

## Common Development Tasks

### Adding New Command Prefixes
Modify the scanning logic in `LoadCommands()`:
```sourcepawn
if (StrContains(sCommand, "sm_") == 0 || 
    StrContains(sCommand, "zr_") == 0 ||
    StrContains(sCommand, "new_prefix_") == 0)  // Add new prefix
```

### Modifying Documentation Format
Edit `WriteCommandHelper()` and `SaveCommandsDocumentation()` functions:
- Change markdown structure
- Add new sections
- Modify admin flag descriptions

### Adding New Admin Flags
Extend the flag switch statement in `WriteCommandHelper()`:
```sourcepawn
case (Admin_NewFlag):
{
    sFlag = "Admin_NewFlag: Description of new flag";
}
```

### Customizing Menu Display
Modify `Command_listcmd()` and `Handler_CMDmenu()`:
- Change menu title and formatting
- Add filtering options
- Modify display information

## Dependencies Management

### External Dependencies
- **Basic Plugin**: Required for methodmap functionality
- **SourceMod**: Platform dependency (auto-managed by SourceKnight)

### Adding New Dependencies
Update `sourceknight.yaml`:
```yaml
dependencies:
  - name: new-plugin
    type: git
    repo: https://github.com/user/repo
    unpack:
    - source: /addons/sourcemod/scripting/include
      dest: /addons/sourcemod/scripting/include
```

## Performance Considerations

### Optimization Guidelines
- **Command Scanning**: Performed once on `OnAllPluginsLoaded()`
- **Menu Generation**: Built dynamically but uses cached command list
- **Sorting Algorithm**: Simple bubble sort (O(n²)) - consider optimization for large command sets
- **Memory Usage**: Commands stored in ArrayList with methodmap objects

### Potential Performance Issues
- Large number of commands may slow initial loading
- Frequent menu access shouldn't impact server performance
- File I/O for documentation generation is minimal

## Debugging & Troubleshooting

### Common Issues
1. **Plugin Fails to Load**: Check SourceMod version compatibility
2. **Commands Not Detected**: Verify plugin load order (use `OnAllPluginsLoaded`)
3. **Documentation Not Generated**: Check file permissions and path
4. **Memory Leaks**: Ensure proper `delete` usage, avoid `.Clear()`

### Debugging Techniques
- Use SourceMod error logs: `addons/sourcemod/logs/errors_*.log`
- Add `LogMessage()` calls for debugging
- Test with minimal plugin set to isolate issues
- Verify admin flags are properly set

### Testing Checklist
- [ ] Plugin compiles without warnings
- [ ] Plugin loads on server startup
- [ ] `sm_listcmd` displays command menu
- [ ] Documentation file is generated
- [ ] Admin and console commands are properly categorized
- [ ] Memory usage is stable (no leaks)

## Version Control & Releases

### Commit Standards
- Use descriptive commit messages
- Keep changes focused and atomic
- Test builds before committing

### Release Process
- GitHub Actions automatically builds on push
- Tags trigger versioned releases
- Artifacts include compiled plugins and documentation

### Versioning
- Plugin version defined in `myinfo` structure
- Follow semantic versioning (MAJOR.MINOR.PATCH)
- Update version number for significant changes

---

## Quick Reference

### Key Files to Modify
- `CommandHelper.sp`: Main plugin logic
- `CCommandHelper.inc`: Command object structure
- `sourceknight.yaml`: Build configuration

### Important Functions
- `LoadCommands()`: Scans and collects commands
- `SaveCommandsDocumentation()`: Generates markdown
- `WriteCommandHelper()`: Formats documentation sections
- `Command_listcmd()`: In-game menu handler

### Build Commands
```bash
# Trigger CI build
git push

# Check build status
# Visit GitHub Actions tab in repository
```

This plugin serves as a documentation generator and command browser for SourceMod environments. When making changes, always consider the impact on both the generated documentation and the in-game user experience.